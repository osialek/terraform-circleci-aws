jobs:
  build_terraform_validate:
    machine: 
      image: ubuntu-2204:2024.04.4
    steps:
      - checkout
      - run:
          name: installing AWS CLI
          command: |
            sudo apt-get update
            sudo apt install python3-pip
            sudo pip3 install awsebcli --upgrade
      # - run: cd ./app && npm install && npm run build
      - run: 
          name: installing terraform
          command: |
            wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
            echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
            sudo apt update && sudo apt install terraform
      - run:
          name: validate terraform installation
          command: |
            terraform version
            ls
      - persist_to_workspace:
          root: .
          paths:
            - .
  build_terragrunt_plan:
    machine:
      image: ubuntu-2204:2024.04.4
    steps:
      - attach_workspace:
         at: .
      - checkout
      # - run:
      #     name: installing AWS CLI
      #     command: |
      #       sudo apt-get update
      #       sudo apt install python3-pip
      #       sudo pip3 install awsebcli --upgrade
      # # - run: cd ./app && npm install && npm run build
      # - run: 
      #     name: installing terraform
      #     command: |
      #       wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
      #       echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
      #       sudo apt update && sudo apt install terraform
      - run:
          name: validate terraform installation
          command: |
            terraform version
      - run:
          name: installing terragrunt
          command: |
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            (echo; echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"') >> /home/circleci/.bashrc
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
            brew install terragrunt
            sudo apt-get install build-essential
      - run:
          name: validate terragrunt installation
          command: terragrunt --version
      - run:
            name: terragrunt plan
            command: |
              cd environments/dev/network
              terragrunt plan
workflows:
  version: 2
  execute_terraform_validate:
    jobs:
      - build_terraform_validate
      - build_terragrunt_plan:
          requires:
            - build_terraform_validate

  # execute_terragrunt_plan:
  #   jobs:
  #     - build_terragrunt_plan
